{% extends 'news/base.html' %}

{% block title %}{{ article.title }}{% endblock %}

{% block content %}
<div class="content-with-sidebar">
    <div class="main-content">
        <article class="news-article">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <header class="article-header">
                <h1>{{ article.title }}</h1>
                <div class="article-meta">
                    <span class="date">{{ article.created_at|date:"d.m.Y H:i" }}</span>
                    <span class="author">–ê–≤—Ç–æ—Ä: {{ article.author.username }}</span>
                    <span class="views">üëÅ {{ article.views }}</span>
                    <span class="comments-count">üí¨ {{ article.get_comments_count }}</span>
                </div>
                
                <div class="article-tags">
                    {% for tag in article.tags.all %}
                    <a href="{% url 'news:articles_by_tag' tag.slug %}" class="tag" style="background-color: {{ tag.color }}">
                        {{ tag.name }}
                    </a>
                    {% endfor %}
                </div>
            </header>

            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç—å–∏ -->
            <section class="article-content">
                {% for block in article.blocks.all %}
                    {% if block.block_type == 'text' %}
                        <div class="text-block">
                            {{ block.content|linebreaks }}
                        </div>
                    
                    {% elif block.block_type == 'image' and block.image %}
                        <div class="image-block">
                            <img src="{{ block.image.url }}" alt="{{ block.image_caption }}" class="article-image">
                            {% if block.image_caption %}
                                <p class="image-caption">{{ block.image_caption }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </section>
        </article>

<!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<section class="comments-section">
    <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ article.get_comments_count }})</h3>
    
    {% if article.comments_enabled %}
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        {% if user.is_authenticated %}
        <div class="comment-form main-form">
            <h4>üí≠ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
            <form method="post" class="comment-form">
                {% csrf_token %}
                {{ comment_form.parent }}
                <div class="form-group">
                    {{ comment_form.content }}
                </div>
                <button type="submit" class="btn btn-primary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </form>
        </div>
        {% else %}
        <div class="auth-required">
            <p>üîí –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è <a href="{% url 'admin:login' %}">–≤–æ–π–¥–∏—Ç–µ</a> –≤ —Å–∏—Å—Ç–µ–º—É.</p>
        </div>
        {% endif %}

        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div class="comments-list" id="comments-list">
            {% for comment in comments %}
                {% include 'news/comment.html' with comment=comment %}
            {% empty %}
            <p class="no-comments">üò¥ –ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
            {% endfor %}
        </div>
    {% else %}
        <div class="comments-disabled">
            <p>üîí –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã.</p>
        </div>
    {% endif %}
</section>

        <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ -->
        {% if popular_articles %}
        <div class="popular-articles">
            <h3>–°–∞–º—ã–µ —á–∏—Ç–∞–µ–º—ã–µ</h3>
            <div class="popular-list">
                {% for popular in popular_articles %}
                <div class="popular-item">
                    <a href="{% url 'news:article_detail' popular.slug %}">{{ popular.title }}</a>
                    <span class="views">üëÅ {{ popular.views }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="article-actions">
            <a href="{% url 'news:article_list' %}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Å—Ç–∞—Ç–µ–π</a>
        </div>
    </div>
    
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside class="sidebar">
        <div class="tags-cloud">
            <h3>–í—Å–µ —Ç–µ–≥–∏</h3>
            <div class="tags-list">
                {% for tag in all_tags %}
                <a href="{% url 'news:articles_by_tag' tag.slug %}" class="tag" style="background-color: {{ tag.color }}">
                    {{ tag.name }}
                </a>
                {% endfor %}
            </div>
        </div>
    </aside>
</div>

<script>
// –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –æ—Ç–≤–µ—Ç–∞
function showReplyForm(commentId) {
    console.log('–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', commentId);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–æ–≤
    const allReplyForms = document.querySelectorAll('.reply-form');
    allReplyForms.forEach(form => {
        form.style.display = 'none';
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ–æ—Ä–º—É
    const replyForm = document.getElementById('reply-form-' + commentId);
    if (replyForm) {
        replyForm.style.display = 'block';
        
        // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ñ–æ—Ä–º–µ
        replyForm.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        
        // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ
        const textarea = replyForm.querySelector('textarea');
        if (textarea) {
            textarea.focus();
        }
    } else {
        console.error('–§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', commentId);
    }
}

// –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –æ—Ç–≤–µ—Ç–∞
function hideReplyForm(commentId) {
    console.log('–°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', commentId);
    
    const replyForm = document.getElementById('reply-form-' + commentId);
    if (replyForm) {
        replyForm.style.display = 'none';
        
        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
        const textarea = replyForm.querySelector('textarea');
        if (textarea) {
            textarea.value = '';
        }
    }
}

// –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã (–±–µ–∑ AJAX)
function submitReplyForm(form, commentId) {
    const textarea = form.querySelector('textarea');
    if (textarea && !textarea.value.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞!');
        return false;
    }
    return true; // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
}

// –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ "–û—Ç–≤–µ—Ç–∏—Ç—å" (–≤–∫–ª—é—á–∞—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ)
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-reply')) {
            const commentId = event.target.getAttribute('onclick')?.match(/\d+/)?.[0];
            if (commentId) {
                showReplyForm(parseInt(commentId));
            }
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ "–û—Ç–º–µ–Ω–∞"
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-secondary') && 
            event.target.textContent.includes('–û—Ç–º–µ–Ω–∞')) {
            const commentId = event.target.getAttribute('onclick')?.match(/\d+/)?.[0];
            if (commentId) {
                hideReplyForm(parseInt(commentId));
            }
        }
    });
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é –∏–∑ URL hash
    if (window.location.hash) {
        const commentId = window.location.hash.substring(1);
        const commentElement = document.getElementById(commentId);
        if (commentElement) {
            setTimeout(() => {
                commentElement.scrollIntoView({ behavior: 'smooth' });
                commentElement.classList.add('comment-highlight');
                setTimeout(() => {
                    commentElement.classList.remove('comment-highlight');
                }, 3000);
            }, 500);
        }
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        const messages = document.querySelectorAll('.alert');
        messages.forEach(message => {
            message.style.opacity = '0';
            setTimeout(() => {
                if (message.parentElement) {
                    message.parentElement.remove();
                }
            }, 300);
        });
    }, 5000);
});
</script>

{% endblock %}